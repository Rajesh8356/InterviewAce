<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Face Capture — InterviewAce</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --primary:#304160;
      --accent:#4aa3ff;
      --bg:#f4f8fb;
      --card:#fff;
      --success:#27ae60;
      --danger:#e74c3c;
    }
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--primary);}
    .wrap{max-width:900px;margin:36px auto;padding:20px;}
    .card{background:var(--card);border-radius:14px;padding:26px;box-shadow:0 10px 30px rgba(30,40,60,0.06);}
    h1{margin:0 0 8px;font-size:28px;color:var(--primary);}
    p.lead{margin:0 0 18px;color:#556;}
    .row{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;}
    .left{flex:1;min-width:300px}
    .right{width:220px}
    video{width:100%;height:auto;border-radius:10px;background:#000;display:block;}
    .preview-grid{display:flex;gap:10px;justify-content:space-between;margin-top:16px;}
    .preview-grid img{width:70px;height:70px;object-fit:cover;border-radius:8px;border:2px solid #ddd;}
    .preview-grid img.ready{border-color:var(--success);}
    .status{margin-top:12px;font-weight:600;}
    .countdown{
      position:absolute;left:50%;top:40%;transform:translate(-50%,-50%);
      background:rgba(0,0,0,0.55);color:#fff;padding:18px 24px;border-radius:14px;font-size:48px;display:flex;align-items:center;justify-content:center;min-width:110px;
    }
    .controls{display:flex;gap:10px;align-items:center;margin-top:12px;}
    .btn{background:var(--primary);color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600;}
    .muted{background:#eef;padding:8px 10px;border-radius:8px;color:#345;}
    .progress-wrap{height:10px;background:#eee;border-radius:8px;margin-top:14px;overflow:hidden}
    .progress{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--primary));transition:width .35s}
    .instructions{background:#f7fbff;padding:12px;border-radius:10px;border-left:4px solid var(--accent);color:#234}
    .danger{color:var(--danger);font-weight:700;margin-top:10px}
    /* responsive */
    @media (max-width:700px){
      .row{flex-direction:column}
      .right{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Face Capture</h1>
      <p class="lead">We automatically capture three clear photos (center, left, right). Please allow camera access and follow the on-screen countdowns.</p>

      <div class="row">
        <div class="left">
          <div style="position:relative;">
            <video id="video" autoplay playsinline muted></video>
            <div id="countOverlay" class="countdown" style="display:none">3</div>
          </div>

          <div class="instructions" style="margin-top:14px">
            <strong>Quick tips:</strong>
            <ul style="margin:10px 0 0 18px;padding:0;color:#345">
              <li>Face camera in good lighting</li>
              <li>Hold still during the 3..2..1 countdown</li>
              <li>Turn slightly left and right when prompted</li>
            </ul>
          </div>

          <div class="controls">
            <button id="startBtn" class="btn">Start Capture</button>
            <div id="manualFallback" style="display:none;">
              <button id="restartBtn" class="btn" style="background:#556">Retry</button>
            </div>
            <div style="flex:1"></div>
            <div id="statusText" class="muted">Status: waiting</div>
          </div>

          <div class="progress-wrap"><div id="progressBar" class="progress"></div></div>
        </div>

        <div class="right">
          <div style="font-weight:700;margin-bottom:8px">Previews</div>
          <div class="preview-grid">
            <img id="preview0" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0ibW9ub3NwYWNlIiBmb250LXNpemU9IjEyIiBmaWxsPSIjODg4Ij4xPC90ZXh0Pjwvc3ZnPg==" alt="1">
            <img id="preview1" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0ibW9ub3NwYWNlIiBmb250LXNpemU9IjEyIiBmaWxsPSIjODg4Ij4yPC90ZXh0Pjwvc3ZnPg==" alt="2">
            <img id="preview2" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0ibW9ub3NwYWNlIiBmb250LXNpemU9IjEyIiBmaWxsPSIjODg4Ij4zPC90ZXh0Pjwvc3ZnPg==" alt="3">
          </div>
          <div id="errorMsg" class="danger" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const userId = '{{ user_id }}'; // templated server-side
  const startBtn = document.getElementById('startBtn');
  const restartBtn = document.getElementById('restartBtn');
  const video = document.getElementById('video');
  const previewEls = [document.getElementById('preview0'), document.getElementById('preview1'), document.getElementById('preview2')];
  const countOverlay = document.getElementById('countOverlay');
  const statusText = document.getElementById('statusText');
  const progressBar = document.getElementById('progressBar');
  const errorMsg = document.getElementById('errorMsg');
  const manualFallback = document.getElementById('manualFallback');

  let stream = null;
  let captured = [null, null, null];
  let capturing = false;
 // Push a dummy state so back button doesn't go back
    window.history.pushState(null, null, window.location.href);

    // When back button is pressed
    window.onpopstate = function() {
        // Stay on the same page
        window.history.go(1);
    };
  // If the face capture already completed server-side, redirect immediately (client-side double-check)
  fetch(`/check_face_capture/${userId}`)
    .then(r => r.json())
    .then(data => {
      if (data.completed) {
        statusText.textContent = 'Face capture already completed — redirecting...';
        setTimeout(()=> window.location.href = `/four/${userId}`, 800);
      } else {
        // optionally auto-start camera on load — we wait for user to press Start for better UX/permissions on mobiles.
      }
    })
    .catch(err=>{
      console.error('status check failed', err);
    });

  async function startCamera() {
    errorMsg.style.display = 'none';
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video:{ width:640, height:480, facingMode:'user' } , audio:false });
      video.srcObject = stream;
      statusText.textContent = 'Camera started — preparing automatic capture';
      startBtn.style.display = 'none';
      // small delay before capture begins
      setTimeout(()=> autoCaptureSequence(), 700);
    } catch (err) {
      console.error(err);
      errorMsg.style.display = 'block';
      errorMsg.textContent = 'Unable to access camera. Please allow permission and try again.';
      manualFallback.style.display = 'inline-block';
      statusText.textContent = 'Camera error';
    }
  }

  function showCountdown(n){
    countOverlay.style.display = 'flex';
    countOverlay.textContent = n;
  }
  function hideCountdown(){ countOverlay.style.display = 'none'; }

  async function captureFrameAsDataURL() {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    return canvas.toDataURL('image/jpeg', 0.9);
  }

  async function autoCaptureSequence(){
    if (capturing) return;
    capturing = true;
    statusText.textContent = 'Auto capture starting...';
    const poses = ['center','left','right'];
    for(let i=0;i<3;i++){
      // give user a short instruction text for pose (optional)
      statusText.textContent = `Get ready — capture ${i+1} of 3 (${poses[i]})`;
      // countdown 3..2..1
      for(let c=3;c>=1;c--){
        showCountdown(c);
        await new Promise(res=>setTimeout(res, 700)); // 700ms per count for natural feel
      }
      hideCountdown();
      // capture frame
      try {
        const dataUrl = await captureFrameAsDataURL();
        captured[i] = dataUrl;
        previewEls[i].src = dataUrl;
        previewEls[i].classList.add('ready');
        progressBar.style.width = `${((i+1)/3)*100}%`;
        statusText.textContent = `Captured ${i+1}/3`;
        // small pause for user to turn head for next pose
        await new Promise(res=>setTimeout(res, 700));
      } catch (err) {
        console.error('capture error', err);
        errorMsg.style.display='block';
        errorMsg.textContent = 'Failed to capture image. Retrying...';
        capturing = false;
        return;
      }
    }

    // All 3 captured — auto submit
    statusText.textContent = 'Submitting images...';
    await submitCapturedImages();
  }

  async function submitCapturedImages(){
    // create form data as your server expects (image_0, image_1, image_2)
    try {
      const fd = new FormData();
      for(let i=0;i<3;i++){
        if(!captured[i]) throw new Error('Missing capture');
        fd.append(`image_${i}`, captured[i]);
      }

      const resp = await fetch(`/start_face_capture/${userId}`, {
        method:'POST',
        body: fd
      });
      const data = await resp.json();
      if (data.success) {
        progressBar.style.width = '100%';
        statusText.textContent = 'Capture successful — finalizing...';
        // stop camera
        if (stream) {
          stream.getTracks().forEach(t=>t.stop());
          stream = null;
        }
        // redirect to four
        setTimeout(()=> window.location.href = `/four/${userId}`, 900);
      } else {
        // show error and allow retry
        errorMsg.style.display='block';
        errorMsg.textContent = `Server error: ${data.error || 'Unknown'}`;
        statusText.textContent = 'Failed to submit — please retry';
        manualFallback.style.display='inline-block';
      }
    } catch (err) {
      console.error('submit error', err);
      errorMsg.style.display='block';
      errorMsg.textContent = 'Network error while submitting. Please check connection and retry.';
      manualFallback.style.display='inline-block';
      statusText.textContent = 'Submission failed';
    } finally {
      capturing = false;
    }
  }

  startBtn.addEventListener('click', startCamera);
  restartBtn?.addEventListener('click', ()=>{
    // reset
    captured = [null,null,null];
    previewEls.forEach(el=>{
      el.src = el.getAttribute('data-placeholder') || el.src;
      el.classList.remove('ready');
    });
    progressBar.style.width = '0%';
    errorMsg.style.display='none';
    startBtn.style.display = 'inline-block';
    manualFallback.style.display = 'none';
    statusText.textContent = 'Ready';
  });

  // Prevent back navigation to this page after success
  window.history.pushState(null, "", window.location.href);
  window.addEventListener("popstate", function() {
    // redirect to four
    window.location.replace(`/four/${userId}`);
  });

  // Autostart on desktops: attempt to start camera automatically after short delay
  // (Many mobile browsers require a user gesture so we still keep Start button.)
  setTimeout(()=>{
    // small heuristics: if on a desktop (screen width > 720) try to start
    if (screen.width > 720) {
      // try to start camera automatically (fails silently if permission blocked)
      startCamera().catch(()=>{/*ignored*/});
    }
  }, 400);
history.pushState(null, null, location.href);
window.onpopstate = function() {
    history.go(1);
};
</script>
</body>
</html>
